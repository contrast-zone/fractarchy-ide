<!DOCTYPE html>
<!--?xml version="1.0"?-->
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:svg="http://www.w3.org/2000/svg">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <title>Fractarchy-ORG</title>
    <link rel="icon" type="image/png" href="./media/favicon128.png"/>

    <!-- Primary Meta Tags -->
    <meta name="title" content="Fractarchy-ORG">
    <meta name="description" content="Hierarchical content organizer featuring structured document tree file format. Fractal-structure inspired, parent-child orbiting, zooming-elements based.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://github.com/contrast-zone/fractarchy-org">
    <meta property="og:title" content="Fractarchy-ORG">
    <meta property="og:description" content="Hierarchical content organizer featuring structured document tree file format. Fractal-structure inspired, parent-child orbiting, zooming-elements based.">
    <meta property="og:image" content="media/socmedia.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://github.com/contrast-zone/fractarchy-org">
    <meta property="twitter:title" content="Fractarchy-ORG">
    <meta property="twitter:description" content="Hierarchical content organizer featuring structured document tree file format. Fractal-structure inspired, parent-child orbiting, zooming-elements based.">
    <meta property="twitter:image" content="media/socmedia.png">

    <!--meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no"-->
    
    <head>
        <style media="screen">
            html {
                /*filter: sepia(0.2);*/
            }

            html, body
            {
                overflow: hidden;
                height: 100%;
                width: 100%;
                margin-top: 0px;
                margin-left: 0px;
                pointer-events: auto;
                /*touch-action: pinch-zoom;*/
                touch-action: none;
                user-select: none;
                background-color: gray;
            }
            
            .center {
              display: flex;
              justify-content: center;
              align-items: center;
              flex-direction: column;
            }
            
            svg {opacity : 0.7;}
            svg:hover {cursor: pointer; opacity :1;}
            
            a {display: none}
        </style>
        <style>
            @media print {
              html, body {
                display: none;  /* hide whole page */
              }
            }
        </style>
        <script src="src/parser.js"></script>
    </head>
    <body>
        <noscript>
            title: Fractadocs
            tags: digital-workbook, text-processing, hierarchical-data, fractal-structure-inspired, parent-child-orbiting, zooming-elements-based
        </noscript>
        <iframe id="source" style="visibility: hidden; border-style:none; position:fixed;/* top:0; left:0; bottom:0; right:0; width:100%; height:100%;*/ border:none; background-color: gray;"></iframe>
        <iframe id="target" style="visibility: hidden; border-style:none; position:fixed;/* top:0; left:0; bottom:0; right:0; width:100%; height:100%;*/ border:none; background-color: gray;"></iframe>
        <!--a id="fullscrbtn" class="btn" style="position: absolute; text-shadow: 0px 0px 10px black;" hidden>
            <i class="material-icons" style="font-size: 7em;">fullscreen</i>
        </a-->
        <a id="btnlhlp" style="position: absolute; background-color: rgb(48,48,48); border-radius: 24px; /*filter: drop-shadow(0px 0px 5px black);*/" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display: block;">
                <title>help</title>
                <path fill="rgb(208,208,208)" stroke-width="1px" d="M24.1 35.65q.9 0 1.6-.7.7-.7.7-1.65 0-.9-.7-1.575-.7-.675-1.6-.675-.95 0-1.625.675T21.8 33.35q0 .9.675 1.6.675.7 1.625.7Zm-2.15-7.3h3.7q0-1.2.325-2.275T27.85 23.7q1.45-1.1 2.075-2.4.625-1.3.625-2.9 0-2.8-1.65-4.475-1.65-1.675-4.5-1.675-2.6 0-4.65 1.425-2.05 1.425-3 3.775l3.45 1.3q.6-1.45 1.625-2.2 1.025-.75 2.225-.75 1.25 0 2.1.725.85.725.85 1.975 0 .9-.575 1.825-.575.925-1.575 1.725-1.4 1.2-2.15 2.625t-.75 3.675ZM24 45.25q-4.4 0-8.275-1.65T8.95 39.05q-2.9-2.9-4.55-6.775Q2.75 28.4 2.75 24q0-4.45 1.65-8.325 1.65-3.875 4.55-6.75t6.775-4.55Q19.6 2.7 24 2.7q4.45 0 8.325 1.675 3.875 1.675 6.75 4.55t4.55 6.75Q45.3 19.55 45.3 24q0 4.4-1.675 8.275t-4.55 6.775q-2.875 2.9-6.75 4.55T24 45.25Zm0-4.7q6.9 0 11.725-4.825Q40.55 30.9 40.55 24q0-6.9-4.825-11.725Q30.9 7.45 24 7.45q-6.9 0-11.725 4.825Q7.45 17.1 7.45 24q0 6.9 4.825 11.725Q17.1 40.55 24 40.55ZM24 24Z"/>
            </svg>
        </a>
        <a id="btnrhlp" style="position: absolute; background-color: rgb(208,208,208); border-radius: 24px; /*filter: drop-shadow(0px 0px 5px black);*/" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display: block;">
                <title>help</title>
                <path class="path" fill="rgb(48,48,48)" stroke-width="1px" d="M24.1 35.65q.9 0 1.6-.7.7-.7.7-1.65 0-.9-.7-1.575-.7-.675-1.6-.675-.95 0-1.625.675T21.8 33.35q0 .9.675 1.6.675.7 1.625.7Zm-2.15-7.3h3.7q0-1.2.325-2.275T27.85 23.7q1.45-1.1 2.075-2.4.625-1.3.625-2.9 0-2.8-1.65-4.475-1.65-1.675-4.5-1.675-2.6 0-4.65 1.425-2.05 1.425-3 3.775l3.45 1.3q.6-1.45 1.625-2.2 1.025-.75 2.225-.75 1.25 0 2.1.725.85.725.85 1.975 0 .9-.575 1.825-.575.925-1.575 1.725-1.4 1.2-2.15 2.625t-.75 3.675ZM24 45.25q-4.4 0-8.275-1.65T8.95 39.05q-2.9-2.9-4.55-6.775Q2.75 28.4 2.75 24q0-4.45 1.65-8.325 1.65-3.875 4.55-6.75t6.775-4.55Q19.6 2.7 24 2.7q4.45 0 8.325 1.675 3.875 1.675 6.75 4.55t4.55 6.75Q45.3 19.55 45.3 24q0 4.4-1.675 8.275t-4.55 6.775q-2.875 2.9-6.75 4.55T24 45.25Zm0-4.7q6.9 0 11.725-4.825Q40.55 30.9 40.55 24q0-6.9-4.825-11.725Q30.9 7.45 24 7.45q-6.9 0-11.725 4.825Q7.45 17.1 7.45 24q0 6.9 4.825 11.725Q17.1 40.55 24 40.55ZM24 24Z"/>
            </svg>
        </a>
        <!--a id="btnlmenu" style="position: absolute; color: rgb(208,208,208);" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" height="48" width="48"><title>menu</title><path fill="rgb(208,208,208, 0.2)" d="M5.8 36.35v-3.4h36.4v3.4Zm0-10.65v-3.4h36.4v3.4Zm0-10.65v-3.4h36.4v3.4Z"/></svg>
        </a-->
        <a id="btnledpr" style="position: absolute; color: rgb(208,208,208);">
            <svg id="fold" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="visibility: hidden;"><title>fold</title><path fill="rgb(208,208,208,0.2)" d="m17.15 40.3-2.45-2.45 9.3-9.3 9.3 9.3-2.45 2.45L24 33.45ZM24 19.45l-9.3-9.3 2.45-2.45L24 14.55l6.85-6.85 2.45 2.45Z"/></svg>
            <svg id="svgledpr" xmlns="http://www.w3.org/2000/svg" height="48" width="48"><title>enter edit/print mode</title><path fill="rgb(208,208,208)" d="M23.8 42.2v-3.85L34.65 27.5l3.85 3.85L27.65 42.2Zm-18-10.35V28.4h15.55v3.45Zm34.85-2.65-3.85-3.85 1.45-1.45q.45-.45 1.2-.45t1.2.45l1.45 1.45q.45.45.45 1.2t-.45 1.2ZM5.8 23.3v-3.4h23.9v3.4Zm0-8.55v-3.4h23.9v3.4Z"/></svg>
            <svg id="unfold" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="visibility: hidden;"><title>unfold</title><path fill="rgb(208,208,208,0.2)" d="M24 42.3 14.7 33l2.5-2.5 6.8 6.8 6.8-6.8 2.5 2.5Zm-6.8-24.6-2.5-2.5L24 5.9l9.3 9.3-2.5 2.5-6.8-6.85Z"/></svg>
        </a>
        <a id="btnupload" style="position: absolute; color: rgb(208,208,208);">
            <svg id="svginput" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display:inline;"><title>input from storage</title><path fill="rgb(208,208,208)" d="M9.1 42.3q-1.35 0-2.375-1.025T5.7 38.9V28.7h3.4v10.2h29.8V9H9.1v10.3H5.7V9q0-1.4 1.025-2.4t2.375-1h29.8q1.4 0 2.4 1t1 2.4v29.9q0 1.35-1 2.375T38.9 42.3ZM20.8 34l-2.5-2.5 5.75-5.8H5.7v-3.4h18.35l-5.75-5.8 2.5-2.5 10.05 10Z"/></svg>
            <svg id="svglosel" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display:none"><title>cancel</title><path fill="rgb(208,208,208)" d="m16.6 33.6 7.4-7.4 7.4 7.4 2.2-2.2-7.4-7.4 7.4-7.4-2.2-2.2-7.4 7.4-7.4-7.4-2.2 2.2 7.4 7.4-7.4 7.4ZM24 44.3q-4.15 0-7.875-1.6-3.725-1.6-6.475-4.35Q6.9 35.6 5.3 31.9 3.7 28.2 3.7 24t1.6-7.925q1.6-3.725 4.35-6.45Q12.4 6.9 16.1 5.3T24 3.7q4.2 0 7.925 1.6 3.725 1.6 6.45 4.325T42.7 16.05q1.6 3.7 1.6 7.95 0 4.2-1.6 7.9t-4.325 6.45Q35.65 41.1 31.95 42.7q-3.7 1.6-7.95 1.6Zm0-3.4q7.05 0 11.975-4.95T40.9 24q0-7.05-4.925-11.975T24 7.1q-7 0-11.95 4.925Q7.1 16.95 7.1 24q0 7 4.95 11.95Q17 40.9 24 40.9ZM24 24Z"/></svg>
            <svg id="svgkeepl" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display:none"><title>accept changes</title><path fill="rgb(208,208,208)" d="M21.05 33.3 35.3 19l-2.55-2.5-11.7 11.75-5.9-5.9-2.5 2.5Zm2.95 11q-4.15 0-7.875-1.6-3.725-1.6-6.475-4.35Q6.9 35.6 5.3 31.9 3.7 28.2 3.7 24t1.6-7.925q1.6-3.725 4.35-6.45Q12.4 6.9 16.1 5.3T24 3.7q4.2 0 7.925 1.6 3.725 1.6 6.45 4.325T42.7 16.05q1.6 3.7 1.6 7.95 0 4.2-1.6 7.9t-4.325 6.45Q35.65 41.1 31.95 42.7q-3.7 1.6-7.95 1.6Zm0-3.4q7.05 0 11.975-4.95T40.9 24q0-7.05-4.925-11.975T24 7.1q-7 0-11.95 4.925Q7.1 16.95 7.1 24q0 7 4.95 11.95Q17 40.9 24 40.9ZM24 24Z"/></svg>
        </a>
        <a id="btnlslide" style="position: absolute; color: rgb(208,208,208);">
            <svg id="svglcropfull" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display:inline;"><title>full width</title><path fill="rgb(208,208,208)" d="M9.1 42.3q-1.35 0-2.375-1.025T5.7 38.9V9.1q0-1.4 1.025-2.4t2.375-1h29.8q1.4 0 2.4 1t1 2.4v29.8q0 1.35-1 2.375T38.9 42.3Zm0-3.4h29.8V9.1H9.1v29.8Zm0 0V9.1v29.8Z"/></svg>
            <svg id="svglcrophalf" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display:none;"><title>split</title><path fill="rgb(208,208,208)" d="M28.85 42.3q-1.4 0-2.4-1.025t-1-2.375V9.1q0-1.4 1-2.4t2.4-1h10.2q1.4 0 2.425 1T42.5 9.1v29.8q0 1.35-1.025 2.375T39.05 42.3Zm0-33.2v29.8h10.2V9.1h-10.2ZM8.95 42.3q-1.4 0-2.425-1.025T5.5 38.9V9.1q0-1.4 1.025-2.4t2.425-1h10.2q1.4 0 2.4 1t1 2.4v29.8q0 1.35-1 2.375t-2.4 1.025Zm0-33.2v29.8h10.2V9.1H8.95Zm30.1 0h-10.2 10.2Zm-19.9 0H8.95h10.2Z"/></svg>
        </a>
        <a id="btnredpr" style="position: absolute; color: rgb(208,208,208);">
            <svg id="unfold" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="visibility: hidden;"><title>unfold</title><path fill="rgb(48,48,48,0.2)" d="M24 42.3 14.7 33l2.5-2.5 6.8 6.8 6.8-6.8 2.5 2.5Zm-6.8-24.6-2.5-2.5L24 5.9l9.3 9.3-2.5 2.5-6.8-6.85Z"/></svg>
            <svg id="svgredpr" xmlns="http://www.w3.org/2000/svg" height="48" width="48"><title>enter edit/print mode</title><path fill="rgb(48,48,48)" d="M32.8 15.3V9.1H15.2v6.2h-3.4V5.7h24.4v9.6ZM7.1 18.7h33.8H11.8Zm29.65 5.05q.65 0 1.15-.5.5-.5.5-1.15 0-.65-.5-1.15-.5-.5-1.15-.5-.65 0-1.15.5-.5.5-.5 1.15 0 .65.5 1.15.5.5 1.15.5ZM32.8 39.1v-8.9H15.2v8.9Zm3.4 3.35H11.8v-9H3.7V20.9q0-2.35 1.6-3.975t4-1.625h29.4q2.4 0 4 1.625t1.6 3.975v12.55h-8.1Zm4.7-12.4V20.9q0-.95-.625-1.575T38.75 18.7H9.3q-.95 0-1.575.625T7.1 20.9v9.15h4.7V26.8h24.4v3.25Z"/></svg>
            <svg id="fold" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="visibility: hidden;"><title>fold</title><path fill="rgb(48,48,48,0.2)" d="m17.15 40.3-2.45-2.45 9.3-9.3 9.3 9.3-2.45 2.45L24 33.45ZM24 19.45l-9.3-9.3 2.45-2.45L24 14.55l6.85-6.85 2.45 2.45Z"/></svg>
        </a>
        <a id="btnrslide" style="position: absolute; color: rgb(208,208,208);">
            <svg id="svgrcropfull" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display:inline;"><title>full width</title><path fill="rgb(48,48,48)" d="M9.1 42.3q-1.35 0-2.375-1.025T5.7 38.9V9.1q0-1.4 1.025-2.4t2.375-1h29.8q1.4 0 2.4 1t1 2.4v29.8q0 1.35-1 2.375T38.9 42.3Zm0-3.4h29.8V9.1H9.1v29.8Zm0 0V9.1v29.8Z"/></svg>
            <svg id="svgrcrophalf" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display:none;"><title>split</title><path fill="rgb(48,48,48)" d="M28.85 42.3q-1.4 0-2.4-1.025t-1-2.375V9.1q0-1.4 1-2.4t2.4-1h10.2q1.4 0 2.425 1T42.5 9.1v29.8q0 1.35-1.025 2.375T39.05 42.3Zm0-33.2v29.8h10.2V9.1h-10.2ZM8.95 42.3q-1.4 0-2.425-1.025T5.5 38.9V9.1q0-1.4 1.025-2.4t2.425-1h10.2q1.4 0 2.4 1t1 2.4v29.8q0 1.35-1 2.375t-2.4 1.025Zm0-33.2v29.8h10.2V9.1H8.95Zm30.1 0h-10.2 10.2Zm-19.9 0H8.95h10.2Z"/></svg>
        </a>
        <a id="btndownload" style="position: absolute; color: rgb(48,48,48);">
            <svg id="svgoutput" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display:inline;"><title>output to storage</title><path fill="rgb(48,48,48)" d="M9.1 42.3q-1.35 0-2.375-1.025T5.7 38.9V9.1q0-1.4 1.025-2.4t2.375-1h29.8q1.4 0 2.4 1t1 2.4v4.4h-3.4V9.1H9.1v29.8h29.8v-4.4h3.4v4.4q0 1.35-1 2.375T38.9 42.3Zm25.4-8.85-2.35-2.4 5.3-5.35H18.9v-3.4h18.55l-5.3-5.35 2.35-2.4L43.95 24Z"/></svg>
            <svg id="svgkeepr" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display:none"><title>print document</title><path fill="rgb(48,48,48)" d="M21.05 33.3 35.3 19l-2.55-2.5-11.7 11.75-5.9-5.9-2.5 2.5Zm2.95 11q-4.15 0-7.875-1.6-3.725-1.6-6.475-4.35Q6.9 35.6 5.3 31.9 3.7 28.2 3.7 24t1.6-7.925q1.6-3.725 4.35-6.45Q12.4 6.9 16.1 5.3T24 3.7q4.2 0 7.925 1.6 3.725 1.6 6.45 4.325T42.7 16.05q1.6 3.7 1.6 7.95 0 4.2-1.6 7.9t-4.325 6.45Q35.65 41.1 31.95 42.7q-3.7 1.6-7.95 1.6Zm0-3.4q7.05 0 11.975-4.95T40.9 24q0-7.05-4.925-11.975T24 7.1q-7 0-11.95 4.925Q7.1 16.95 7.1 24q0 7 4.95 11.95Q17 40.9 24 40.9ZM24 24Z"/></svg>
            <svg id="svgloser" xmlns="http://www.w3.org/2000/svg" height="48" width="48" style="display:none"><title>cancel</title><path fill="rgb(48,48,48)" d="m16.6 33.6 7.4-7.4 7.4 7.4 2.2-2.2-7.4-7.4 7.4-7.4-2.2-2.2-7.4 7.4-7.4-7.4-2.2 2.2 7.4 7.4-7.4 7.4ZM24 44.3q-4.15 0-7.875-1.6-3.725-1.6-6.475-4.35Q6.9 35.6 5.3 31.9 3.7 28.2 3.7 24t1.6-7.925q1.6-3.725 4.35-6.45Q12.4 6.9 16.1 5.3T24 3.7q4.2 0 7.925 1.6 3.725 1.6 6.45 4.325T42.7 16.05q1.6 3.7 1.6 7.95 0 4.2-1.6 7.9t-4.325 6.45Q35.65 41.1 31.95 42.7q-3.7 1.6-7.95 1.6Zm0-3.4q7.05 0 11.975-4.95T40.9 24q0-7.05-4.925-11.975T24 7.1q-7 0-11.95 4.925Q7.1 16.95 7.1 24q0 7 4.95 11.95Q17 40.9 24 40.9ZM24 24Z"/></svg>
        </a>
        <!--a id="btnrmenu" style="position: absolute; color: rgb(208,208,208);" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" height="48" width="48"><title>menu</title><path fill="rgb(48,48,48, 0.2)" d="M5.8 36.35v-3.4h36.4v3.4Zm0-10.65v-3.4h36.4v3.4Zm0-10.65v-3.4h36.4v3.4Z"/></svg>
        </a-->
        <div id="helpcontainer" class="center" style="position: absolute; visibility: hidden; left: 0; top: 0; right: 0; bottom: 0; background-color: rgb(128,128,128,0.95);">
            <img id="helpl" src="./media/instrl.svg" height="90%" style="cursor:pointer; display: none"/>
            <img id="helpd" src="./media/instrd.svg" height="90%" style="cursor:pointer; display: none"/>
        </div>
        <div id="iocontainer" class="center" style="position: absolute; visibility: hidden; left: 0; top: 0; right: 0; bottom: 0; background-color: rgb(128,128,128,0.95);">
            <iframe id="iofr" style="display: none; border: none;"></iframe>
        </div>
        <div id="myPopupContainer" style="position: absolute; display: none; left: 0; top: 0; right: 0; bottom: 0;">
            <span id="myPopup" style="padding: 4px; position: absolute; width: 175px; font-family: sans-serif; background-color: rgb(208,208,208); color: rgb(48,48,48);">
                <div id="openDocument" onmouseenter="this.style.backgroundColor='rgb(48,48,48)';this.style.color='rgb(208,208,208)';" onmouseleave="this.style.backgroundColor='rgb(208,208,208)';this.style.color='rgb(48,48,48)';" style="width: 175px;">
                    &nbsp;&nbsp;&nbsp; open document
                </div>
                <div id="newDocument" onmouseenter="this.style.backgroundColor='rgb(48,48,48)';this.style.color='rgb(208,208,208)';" onmouseleave="this.style.backgroundColor='rgb(208,208,208)';this.style.color='rgb(48,48,48)';" style="width: 175px;">
                    &nbsp;&nbsp;&nbsp; new document
                </div>
            </span>
        </div>
        <div id="myPopdownContainer" style="position: absolute; display: none; left: 0; top: 0; right: 0; bottom: 0;">
            <span id="myPopdown" style="padding: 4px; position: absolute; width: 175px; font-family: sans-serif; background-color: rgb(48,48,48); color: rgb(208,208,208)">
                <div id="saveDocument" onmouseenter="this.style.backgroundColor='rgb(208,208,208)';this.style.color='rgb(48,48,48)';" onmouseleave="this.style.backgroundColor='rgb(48,48,48)';this.style.color='rgb(208,208,208)';" style="width: 175px;">
                    &nbsp;&nbsp;&nbsp; save document
                </div>
                <div id="saveAsDocument" onmouseenter="this.style.backgroundColor='rgb(208,208,208)';this.style.color='rgb(48,48,48)';" onmouseleave="this.style.backgroundColor='rgb(48,48,48)';this.style.color='rgb(208,208,208)';" style="width: 175px;">
                    &nbsp;&nbsp;&nbsp; save as
                </div>
            </span>
        </div>
        <script>
            document.addEventListener('contextmenu', event => event.preventDefault());
            
            function backToBrowse () {
                document.getElementById("source").contentWindow.location.replace("./src/source-browse.html");
                document.getElementById("svginput").style.display = "inline";
                document.getElementById("btnledpr").style.display = "inline";
                document.getElementById("svglosel").style.display = "none";
                document.getElementById("svgkeepl").style.display = "none";
                
                document.getElementById("target").contentWindow.location.replace("./src/target-browse.html");
                document.getElementById("svgoutput").style.display = "inline";
                document.getElementById("btnredpr").style.display = "inline";
                document.getElementById("svgloser").style.display = "none";
                document.getElementById("svgkeepr").style.display = "none";


                //document.getElementById("btnlhlp").style.display = "inline";
                document.getElementById("btnrhlp").style.display = "inline";
            }

            var msg = (event) => {
                if (event.data.msg === "edit/print") {
                    srcloaded = false;
                    tgtloaded = false;
                    populateFrom = "browse";

                    //document.getElementById("source").style.backgroundColor = "rgb(48,48,48)";
                    document.getElementById("source").contentWindow.location.replace("./src/source-edit.html");
                    document.getElementById("btnledpr").style.display = "none";
                    document.getElementById("svginput").style.display = "none";
                    document.getElementById("svglosel").style.display = "inline";
                    document.getElementById("svgkeepl").style.display = "inline";
                
                    //document.getElementById("target").style.backgroundColor = "rgb(208,208,208)";
                    document.getElementById("target").contentWindow.location.replace("./src/target-print.html");
                    document.getElementById("btnredpr").style.display = "none";
                    document.getElementById("svgoutput").style.display = "none";
                    document.getElementById("svgloser").style.display = "inline";
                    document.getElementById("svgkeepr").style.display = "inline";

                    document.getElementById("btnlhlp").style.display = "none";
                    document.getElementById("btnrhlp").style.display = "none";
                    
                } else if (event.data.msg === "cancelIO") {
                    hideIO ();
                    
                } else if (event.data.msg === "readFile") {
                    hideIO ();
                    fileInput (event.data.fname);
                    unnamed = false;
                    
                } else if (event.data.msg === "writeFile") {
                    hideIO ();
                    fileOutput (event.data.fname);
                    unnamed = false;

                    var t = document.title;
                    if (t.substring (0, 1) === "*")
                        document.title = t.substring (1, t.length);

                    
                } else if (event.data.msg === "lose") {
                    editedNotAccepted = false;
                    srcloaded = false;
                    tgtloaded = false;
                    populateFrom = "edit/print";
                    
                    backToBrowse ();

                } else if (event.data.msg === "keep") {
                    document.getElementById("source").contentWindow.postMessage({msg: "acceptChanges"}, "*");

                } else if (event.data.msg === "invalidEdit") {
                    document.getElementById("svgkeepl").style.display = "none";
                    document.getElementById("svgkeepr").style.display = "none";

                } else if (event.data.msg === "validEdit") {
                    document.getElementById("svgkeepl").style.display = "inline";
                    document.getElementById("svgkeepr").style.display = "inline";

                } else if (event.data.msg === "acceptChanges") {
                    srcloaded = false;
                    tgtloaded = false;
                    populateFrom = "edit/print";
                    
                    function setNodeTree (pl, cn, nt, newnt) {
                        if (pl > 1) {
                            setNodeTree (pl - 1, cn.children[cn.index], nt[2][cn.index + 1], newnt);
                        
                        } else if (pl === 0 && nt === nodeTree) {
                            nodeTree = newnt;
                            
                        } else {
                            nt[2][cn.index + 1] = newnt;
                        }
                    }

                    if (!currentNode)
                        nodeTree = event.data.nodeTree;
                    
                    else
                        setNodeTree (event.data.currentNode.pathLength, event.data.currentNode.cursor.children[0], nodeTree, event.data.nodeTree);

                    backToBrowse ();
                    var t = document.title;
                    if (t.substring (0, 1) !== "*")
                        document.title = "*" + t;
                    
                } else if (event.data.msg === "syncSource") {
                    currentNode = {cursor: event.data.cursor, pathLength: event.data.pathLength};
                    document.getElementById("source").contentWindow.postMessage({msg: "sync", cursor: event.data.cursor, pathLength: event.data.pathLength}, "*");
                    
                } else  if (event.data.msg === "syncTarget") {
                    currentNode = {cursor: event.data.cursor, pathLength: event.data.pathLength};
                    document.getElementById("target").contentWindow.postMessage({msg: "sync", cursor: event.data.cursor, pathLength: event.data.pathLength}, "*");
                }
            };
            
            document.getElementById("svgledpr").addEventListener ("click", function () {
                msg ({data: {msg: "edit/print"}});
            }, false);
            
            document.getElementById("svgredpr").addEventListener ("click", function () {
                msg ({data: {msg: "edit/print"}});
            }, false);
            
            document.getElementById("svglosel").addEventListener ("click", function () {
                msg ({data: {msg: "lose"}});
            }, false);
            
            document.getElementById("svgloser").addEventListener ("click", function () {
                msg ({data: {msg: "lose"}});
            }, false);
            
            document.getElementById("svgkeepl").addEventListener ("click", function () {
                msg ({data: {msg: "keep"}});
            }, false);

            document.getElementById("svgkeepr").addEventListener ("click", function () {
                document.getElementById("target").contentWindow.frames[0].print();
            }, false);
                        
            document.getElementById("openDocument").addEventListener ("click", function () {
                if (document.title.charAt(0) === "*") {
                    if (confirm("You have unsaved changes. Do you want to lose them?"))
                        showIO ("readDoc", fullUrl);

                } else {
                    showIO ("readDoc", fullUrl);
                }
            }, false);

            document.getElementById("newDocument").addEventListener ("click", function () {
                if (document.title.charAt(0) === "*") {
                    if (confirm("You have unsaved changes. Do you want to lose them?")) {
                        newFile ();
                    }
                    
                } else {
                    newFile ();
                }
            }, false);
            
            document.getElementById("myPopupContainer").addEventListener ("click", function () {
                if (event.target.id !== "svginput") {
                    document.getElementById("myPopupContainer").style.display = "none";
                }
            }, false);
            
            document.getElementById("svginput").addEventListener ("click", async function () {
                if (server === "Node.js") {
                    document.getElementById("myPopup").draggable = false;
                    document.getElementById("myPopup").ondragstart = function () {return false};
                    
                    setTimeout (() => {
                        document.getElementById("myPopup").style.left = document.getElementById("btnupload").offsetLeft + 3 + "px";
                        document.getElementById("myPopup").style.top = document.getElementById("btnupload").offsetTop - document.getElementById("myPopup").clientHeight - 3 + "px";
                    }, 0);                

                    document.getElementById("myPopupContainer").style.display = "inline";

                } else {
                    alert ("Please manually install this application on local computer to use this feature.");
                }

                //showIO ("readDoc", fullUrl);

                /*
                const opts = {
                    suggestedName: fullUrl.substring (fullUrl.lastIndexOf("/") + 1),
                    types: [{
                        description: 'Structured document tree',
                        accept: {'text/plain': ['.sdt']},
                    }],
                };
                try {
                    [fileHandle] = await window.showOpenFilePicker(opts);

                    const file = await fileHandle.getFile();
                    url = (file.path || "") + file.name;
                    if (fileHandle.type = "file") {
                        const content = await file.text();

                        var parsed = parser.parsesexpr (content);
                        if (parsed.err) {
                            var coord = parser.getCoords (content, parsed.pos);
                            alert ("Error: " + parsed.err + " at " + coord.row + ", " + coord.col);
                            
                        } else {
                            baseUrl = getBaseUrl(url);
                            fullUrl = url;
                            document.title = url.substring (url.lastIndexOf("/") + 1);
                            nodeTree = parsed;
                            document.getElementById("source").contentWindow.postMessage({msg: "populate", nodeTree: parsed}, "*");
                            document.getElementById("target").contentWindow.postMessage({msg: "populate", nodeTree: parsed, baseUrl: baseUrl}, "*");
                        }                    
                    }
                } catch (e) {
                }
                */
            }, false);

            document.getElementById("saveDocument").addEventListener ("click", function () {
                if (unnamed)
                    showIO ("writeDoc", fullUrl);
                else
                    fileOutput (fullUrl);
            }, false);

            document.getElementById("saveAsDocument").addEventListener ("click", function () {
                showIO ("writeDoc", fullUrl);
            }, false);
            
            document.getElementById("myPopdownContainer").addEventListener ("click", function () {
                if (event.target.id !== "svgoutput") {
                    document.getElementById("myPopdownContainer").style.display = "none";
                }
            }, false);

            document.getElementById("svgoutput").addEventListener ("click", async function () {
                if (server === "Node.js") {
                    document.getElementById("myPopdown").draggable = false;
                    document.getElementById("myPopdown").ondragstart = function () {return false};
                    setTimeout (() => {
                        document.getElementById("myPopdown").style.left = document.getElementById("btndownload").offsetLeft + document.getElementById("btndownload").clientWidth - document.getElementById("myPopdown").clientWidth - 3 + "px";
                        document.getElementById("myPopdown").style.top = document.getElementById("btndownload").offsetTop + document.getElementById("btndownload").clientHeight - 1 + "px";
                    }, 0);

                    document.getElementById("myPopdownContainer").style.display = "inline";

                } else {
                    alert ("Please manually install this application on local computer to use this feature.");
                }

                //showIO ("writeDoc", fullUrl);
                
                /*
                const opts = {
                  suggestedName: fullUrl.substring (fullUrl.lastIndexOf("/") + 1),
                  types: [{
                    description: 'Structured document tree',
                    accept: {
                      'text/plain': ['.sdt'],
                    },
                  }],
                };
                try {
                    const fileHandle = await window.showSaveFilePicker(opts);
                    const fileStream = await fileHandle.createWritable();
                    await fileStream.write(new Blob([parser.stringify (nodeTree, 50)], {type: "text/plain"}));
                    await fileStream.close();
                } catch (e) {
                }
                */
            }, false);
                        
            window.addEventListener("load", () => {
                window.addEventListener("message", msg, false);
                setSize();                
            });

            var setSize = function () {
                    //var sc = 1;
                    //if (window.matchMedia("(orientation: portrait)").matches)
                    //document
                    //    .querySelector("meta[name=viewport]")
                    //    .setAttribute('content', 'width=device-width', 'initial-scale=' + sc, 'maximum-scale=' + sc, 'minimum-scale=' + sc, 'user-scalable=no');
                /*
                if (window.innerWidth < window.innerHeight) {
                    if (document.getElementById("svglcropfull").style.display === document.getElementById("svgrcropfull").style.display) {
                        document.getElementById("svglcropfull").style.display = "inline";
                        document.getElementById("svglcrophalf").style.display = "none";
                        document.getElementById("svgrcropfull").style.display = "none";
                        document.getElementById("svgrcrophalf").style.display = "inline";
                    }
                }
                */
                if (window.innerWidth < window.innerHeight && slide === "both") {
                    slide = "right";
                }
                
                var s = document.getElementById("source");
                var t = document.getElementById("target");
                var hlpl = document.getElementById("helpl");
                var hlpd = document.getElementById("helpd");
                var f = document.getElementById("fullscrbtn");
                var lm = document.getElementById("btnlmenu");
                var rm = document.getElementById("btnrmenu");
                var lh = document.getElementById("btnlhlp");
                var rh = document.getElementById("btnrhlp");
                
                var bu = document.getElementById("btnupload");
                var bd = document.getElementById("btndownload");
                var lc = document.getElementById("btnlslide");
                var rc = document.getElementById("btnrslide");
                var lf = document.getElementById("btnledpr");
                var rf = document.getElementById("btnredpr");

                var marg = 4;
                var padd = 1;
                var bord = 12;
                var btns = 48;

                var mmarg = marg;
                var onlyleft = false;
                var onlyright = false;
                
                if (slide === "left") {
                    onlyleft = true;
                    marg = 0;
                    document.getElementById("svglcropfull").style.display = "none";
                    document.getElementById("svglcrophalf").style.display = "inline";
                    document.getElementById("svgrcropfull").style.display = "none";
                    document.getElementById("svgrcrophalf").style.display = "inline";

                } else if (slide === "right") {
                    onlyright = true;
                    marg = 0;
                    document.getElementById("svglcropfull").style.display = "none";
                    document.getElementById("svglcrophalf").style.display = "inline";
                    document.getElementById("svgrcropfull").style.display = "none";
                    document.getElementById("svgrcrophalf").style.display = "inline";

                } else {
                    document.getElementById("svglcropfull").style.display = "inline";
                    document.getElementById("svglcrophalf").style.display = "none";
                    document.getElementById("svgrcropfull").style.display = "inline";
                    document.getElementById("svgrcrophalf").style.display = "none";
                }
                /*
                if (slide === "left" || document.getElementById("svglcrophalf").style.display === "inline") {
                //if (slide === "left") {
                    onlyleft = true;
                    marg = 0;
                    
                } else if (slide = "right" || document.getElementById("svgrcrophalf").style.display === "inline") {
                //} else if (slide = "right") {
                    onlyright = true;
                    marg = 0;
                }
                */
                lh.style.visibility = "visible";
                rh.style.visibility = "visible";
                if (!onlyright)
                    s.style.visibility = "visible";
                bu.style.visibility = "visible";
                lc.style.visibility = "visible";
                lf.style.visibility = "visible";
                if (!onlyleft)
                    t.style.visibility = "visible";
                bd.style.visibility = "visible";
                rc.style.visibility = "visible";
                rf.style.visibility = "visible";
                
                s.style.margin = marg + "px";
                s.style.padding = padd + "px";
                s.style.border = bord + "px solid rgb(48,48,48)";
                s.style.borderBottomWidth = btns + "px";
                s.style.top = "0px";
                s.style.left = "0px";
                s.style.height = "calc(100% - " + (2 * (marg + padd) + bord) + "px - " + btns + "px)";
                
                if (onlyleft) {
                    rh.style.visibility = "hidden";
                    t.style.visibility = "hidden";
                    bd.style.visibility = "hidden";
                    rc.style.visibility = "hidden";
                    rf.style.visibility = "hidden";
                    s.style.width = "calc(100% - " + 2 * (marg + padd + bord) + "px)";
                    t.style.width = "calc(100% - " + 2 * (marg + padd + bord) + "px)";
                    
                } else if (!onlyright) {
                    s.style.width = "calc(50% - " + 2 * (marg + padd + bord) + "px)";
                }
                
                window.requestAnimationFrame(function () {
//                setTimeout (() => {
                    lh.style.left = bord + marg + 3 + "px";
                    lh.style.top = marg + bord + 3 + "px";

                    bu.style.left = marg + bord + "px";
                    bu.style.top = mmarg + s.offsetTop + s.offsetHeight - bu.offsetHeight + "px";

                    lc.style.left = (- bord + s.offsetLeft + s.offsetWidth - lc.offsetWidth) + "px";
                    lc.style.top = mmarg + s.offsetTop + s.offsetHeight - lc.offsetHeight + "px";

                    lf.style.left = Math.round (s.offsetWidth / 2 - btns * 3 / 2) + "px"
                    lf.style.top = mmarg + s.offsetTop + s.offsetHeight - lc.offsetHeight + "px";
//                }, 0);
                });
                
                t.style.margin = marg + "px";
                t.style.padding = padd + "px";
                t.style.border = bord + "px solid rgb(208,208,208)";
                t.style.borderTopWidth = btns + "px";
                t.style.top = "0px";
                t.style.right = "0px";
                //t.style.left = Math.floor (window.innerWidth / 2) + "px";
                t.style.height = "calc(100% - " + (2 * (marg + padd) + bord) + "px - " + btns + "px)";

                if (onlyright) {
                    lh.style.visibility = "hidden";
                    s.style.visibility = "hidden";
                    bu.style.visibility = "hidden";
                    lc.style.visibility = "hidden";
                    lf.style.visibility = "hidden";
                    t.style.width = "calc(100% - " + 2 * (marg + padd + bord) + "px)";
                    s.style.width = "calc(100% - " + 2 * (marg + padd + bord) + "px)";
                    
                } else if (!onlyleft) {
                    t.style.width = "calc(50% - " + 2 * (marg + padd + bord) + "px)";
                }
                
                window.requestAnimationFrame(function () {
//                setTimeout (() => {
                    rh.style.right = marg + bord + 4 + "px";
                    rh.style.bottom = bord + marg + 4 + "px";

                    bd.style.right = marg + bord + "px";
                    bd.style.top = marg + "px";
                    
                    rc.style.left = (bord + t.offsetLeft) + "px";
                    rc.style.top = marg + "px";

                    rf.style.top = marg + "px";
                    rf.style.left = t.offsetLeft + Math.round(t.offsetWidth / 2 - btns * 3 / 2) + "px";
//                }, 0);
                });
                
                hlpl.style.transform = "scale(" + 1 + ")";
                hlpd.style.transform = "scale(" + 1 + ")";
                var hh = window.innerHeight / hlpl.clientHeight * 0.85;
                hlpl.style.transform = "scale(" + hh + ")";
                hlpd.style.transform = "scale(" + hh + ")";
            };

            var toggleFullScreen = function () {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen();
                } else {
                    if (document.exitFullscreen) {
                      document.exitFullscreen();
                    }
                }
            }

            var showHelp = function (mode) {
                if (mode === "light") {
                    document.getElementById("helpl").style.display = "inline";
                    document.getElementById("helpd").style.display = "none";
                } else {
                    document.getElementById("helpl").style.display = "none";
                    document.getElementById("helpd").style.display = "inline";
                }

                var h = document.getElementById("helpcontainer");
                /*
                var f = 0.95;
                var fun = function () {
                    if (f > 0) {
                        h.style.opacity = 1 - f;
                        f -= 0.5;
                        setTimeout (fun, 50);
                    } else {
                        h.style.visibility = "visible";
                        h.style.opacity = 1;
                    }
                };
                
                h.style.opacity = 0;
                h.style.visibility = "visible";
                setTimeout(fun, 50);
                */
                h.style.visibility = "visible";
                h.style.opacity = 1;
            }
            
            var hideHelp = function () {
                var h = document.getElementById("helpcontainer");
                /*
                var f = 0.95;
                var fun = function () {
                    if (f > 0) {
                        h.style.opacity = f;
                        f -= 0.5;
                        setTimeout (fun, 50);
                    } else {
                        h.style.visibility = "hidden";
                        h.style.opacity = 0;
                    }
                };
                
                h.style.opacity = 1;
                h.style.visibility = "visible";
                setTimeout(fun, 50);
                */
                h.style.visibility = "hidden";
                h.style.opacity = 0;
            }
            
            var showIO = function (mode, url) {
                document.getElementById("iofr").style.display = "inline";
                document.getElementById("iofr").style.width = Math.min (640, screen.width) + "px";
                document.getElementById("iofr").style.height = Math.min (480, screen.height) + "px";
                
                document.getElementById("iofr").onload = function () {
                    h.style.visibility = "visible";
                    h.style.opacity = 1;
                }

                if (mode === "readDoc") {
                    document.getElementById("iofr").contentWindow.location.replace("./src/file-picker.html?mode=" + mode + "&url=" + url);

                } else if (mode === "writeDoc") {
                    document.getElementById("iofr").contentWindow.location.replace("./src/file-picker.html?mode=" + mode + "&url=" + url);
                }

                var h = document.getElementById("iocontainer");
                /*
                var f = 0.95;
                var fun = function () {
                    if (f > 0) {
                        h.style.opacity = 1 - f;
                        f -= 0.5;
                        setTimeout (fun, 50);
                    } else {
                        h.style.visibility = "visible";
                        h.style.opacity = 1;
                    }
                };
                
                h.style.opacity = 0;
                h.style.visibility = "visible";
                setTimeout(fun, 50);
                */
            }
            
            var hideIO = function () {
                var h = document.getElementById("iocontainer");
                /*
                var f = 0.95;
                var fun = function () {
                    if (f > 0) {
                        h.style.opacity = f;
                        f -= 0.5;
                        setTimeout (fun, 50);
                    } else {
                        h.style.visibility = "hidden";
                        h.style.opacity = 0;
                        document.getElementById("iofr").style.display = "none";
                    }
                };
                
                h.style.opacity = 1;
                h.style.visibility = "visible";
                setTimeout(fun, 50);
                */
                h.style.visibility = "hidden";
                h.style.opacity = 0;
                document.getElementById("iofr").style.display = "none";
            }
            
            var resizeId;
            window.addEventListener('resize', function () {
                if (populateFrom === "browse") {
                    hideAll ();
                    clearTimeout(resizeId);
                    resizeId = setTimeout(function () {
                        setSize ();
                    }, 50);
                    
                } else {
                    hideAll ();
                    clearTimeout(resizeId);
                    resizeId = setTimeout(function () {
                        setSize ();
                    }, 50);
                }
            });
/*
            window.orientation.addEventListener('change', function(e) {
            //window.addEventListener("orientationchange", function () {
                hideAll ();
                clearTimeout(resizeId);
                resizeId = setTimeout(function () {
                    var sc = 1;
                    //if (window.matchMedia("(orientation: portrait)").matches)
                    document
                        .querySelector("meta[name=viewport]")
                        .setAttribute('content', 'width=device-width', 'initial-scale=' + sc, 'maximum-scale=' + sc, 'minimum-scale=' + sc, 'user-scalable=no');

//                    setSize ();
                }, 10);
            });
*/
            //document.getElementById("fullscrbtn").addEventListener('click', toggleFullScreen);
            document.getElementById("helpcontainer").addEventListener('click', hideHelp);
            
            document.getElementById("source").addEventListener("touchstart", function (evt) {
                evt.preventDefault ();
            }, false);

            document.getElementById("target").addEventListener("touchstart", function (evt) {
                evt.preventDefault ();
            }, false);

            document.getElementById("btnlslide").addEventListener('click', () => {
                document.getElementById("source").activeElement.blur ();
                setSize();

                if (window.innerWidth < window.innerHeight) {
                    //document.getElementById("svglcropfull").style.display = "none";
                    //document.getElementById("svglcrophalf").style.display = "inline";
                    //document.getElementById("svgrcropfull").style.display = "none";
                    //document.getElementById("svgrcrophalf").style.display = "inline";
                    slide = "right";

                } else {
                    if (document.getElementById("svglcropfull").style.display === "none") {
                        //document.getElementById("svglcropfull").style.display = "inline";
                        //document.getElementById("svglcrophalf").style.display = "none";
                        slide = "both";
                        
                    } else {
                        //document.getElementById("svglcropfull").style.display = "none";
                        //document.getElementById("svglcrophalf").style.display = "inline";
                        slide = "left";
                    }
                    
                }
                
                setSize();
            }, false);
            
            document.getElementById("btnrslide").addEventListener('click', () => {
                if (window.innerWidth < window.innerHeight) {
                    //document.getElementById("svglcropfull").style.display = "none";
                    //document.getElementById("svglcrophalf").style.display = "inline";
                    //document.getElementById("svgrcropfull").style.display = "none";
                    //document.getElementById("svgrcrophalf").style.display = "inline";
                    slide = "left";

                } else {
                    if (document.getElementById("svgrcropfull").style.display === "none") {
                        //document.getElementById("svgrcropfull").style.display = "inline";
                        //document.getElementById("svgrcrophalf").style.display = "none";
                        slide = "both";
                        
                    } else {
                        //document.getElementById("svgrcropfull").style.display = "none";
                        //document.getElementById("svgrcrophalf").style.display = "inline";
                        slide = "right";
                    }
                    
                }
                
                setSize();
            }, false);

            document.getElementById("btnlhlp").addEventListener('click', () => {showHelp ("dark");});
            document.getElementById("btnrhlp").addEventListener('click', () => {showHelp ("light");});
            
            function sync () {
                function bindIFrameMousedown(iframe, fun){
                    iframe.contentWindow.addEventListener('mousedown', function(event) {
                        var clRect = iframe.getBoundingClientRect();
                        var evt = new CustomEvent('mousedown', {bubbles: true, cancelable: false});

                        evt.clientX = event.clientX + clRect.left;
                        evt.clientY = event.clientY + clRect.top;
                        evt.which = event.which;

                        iframe.dispatchEvent(evt);
                        
                        fun ();
                    });
                };
                
                function loadSource () {
                    document.getElementById("source").contentWindow.postMessage({msg: "loaded"}, "*");
                    document.getElementById("target").contentWindow.postMessage({msg: "unloaded"}, "*");
                }

                function loadTarget () {
                    document.getElementById("source").contentWindow.postMessage({msg: "unloaded"}, "*");
                    document.getElementById("target").contentWindow.postMessage({msg: "loaded"}, "*");
                }

                bindIFrameMousedown(document.getElementById('source'), loadTarget);
                bindIFrameMousedown(document.getElementById('target'), loadSource);
                document.getElementById("source").contentWindow.addEventListener("touchstart", loadTarget, false);
                document.getElementById("target").contentWindow.addEventListener("touchstart", loadSource, false);
            }
            
            function getBaseUrl (url) {
                var baseUrl = url;
                const base = document.createElement('base');
                base.href = baseUrl;
                const head = document.getElementsByTagName('head')[0];
                head.insertBefore(base, head.childNodes[0]);
                baseUrl = base.baseURI.substring(0, base.baseURI.lastIndexOf("/") + 1);
                base.remove();
                
                return baseUrl;
            }
            
            function afterGettingUrl (url, baseUrl, parsed) {
                document.title = url.substring (url.lastIndexOf("/") + 1);
                nodeTree = parsed;
                document.getElementById("source").contentWindow.postMessage({msg: "populate", nodeTree: parsed}, "*");
                document.getElementById("target").contentWindow.postMessage({msg: "populate", nodeTree: parsed, baseUrl: baseUrl}, "*");
            }

            function onlineInput (url) {
                var xhttp = new XMLHttpRequest ();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        var txt = this.responseText;
                        var parsed = parser.parsesexpr (txt);
                        if (parsed.err) {
                            var coord = parser.getCoords (txt, parsed.pos);
                            alert ("Error: " + parsed.err + " at " + coord.row + ", " + coord.col);
                            
                        } else {
                            baseUrl = getBaseUrl(url);
                            fullUrl = url;
                            afterGettingUrl (fullUrl, baseUrl, parsed);
                        }
                    }
                }
                xhttp.open("GET", url, true);
                xhttp.overrideMimeType("text/plain");
                xhttp.send();
            }

            function fileInput (url) {
                var xhttp = new XMLHttpRequest ();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 404) {
                        alert("HTTP error 404. File '" + url + "' does not exist.");
                        
                    } else if (this.readyState == 4 && this.status == 200) {
                        var txt = this.responseText;
                        var parsed = parser.parsesexpr (txt);
                        if (parsed.err) {
                            var coord = parser.getCoords (txt, parsed.pos);
                            alert ("Error: " + parsed.err + " at " + coord.row + ", " + coord.col);
                            
                        } else {
                            if (url.charAt(0) === ".") {
                                var xhttp = new XMLHttpRequest ();
                                xhttp.onreadystatechange = function () {
                                    if (this.readyState == 4 && this.status == 200) {
                                        fullUrl = this.responseText;
                                        var bu = fullUrl.split ("/");
                                        bu.pop ();
                                        baseUrl = bu.join("/");
                                        afterGettingUrl (fullUrl, baseUrl, parsed);
                                    }
                                }
                                xhttp.open("GET", "getAbsDir?fname=" + encodeURIComponent (url), true);
                                xhttp.overrideMimeType("text/plain");
                                xhttp.send();

                            } else if (url.charAt(0) === "/") {
                                baseUrl = url.substring (0, url.lastIndexOf("/"));
                                fullUrl = url;
                                afterGettingUrl (fullUrl, baseUrl, parsed);
                            
                            } else {
                                baseUrl = getBaseUrl(url);
                                fullUrl = url;
                                afterGettingUrl (fullUrl, baseUrl, parsed);
                            }
                                
                        }                    
                    }
                };
                xhttp.open("GET", "open-file?fname=" + encodeURIComponent (url), true);
                xhttp.overrideMimeType("text/plain");
                xhttp.send();
            }
            
            function newFile () {
                var xhttp = new XMLHttpRequest ();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        unnamed = true;
                        baseUrl = this.responseText;
                        fullUrl = this.responseText + "/new document.sdt";
                        document.title = "*new document";
                        nodeTree = ["tree", ["node"], ["branches", ["tree", ["node"], ["branches"]], ["tree", ["node"], ["branches"]]]];
                        document.getElementById("source").contentWindow.postMessage({msg: "populate", nodeTree: nodeTree}, "*");
                        document.getElementById("target").contentWindow.postMessage({msg: "populate", nodeTree: nodeTree, baseUrl: baseUrl}, "*");
                    }
                };
                xhttp.open("GET", "getHomeDir", true);
                xhttp.overrideMimeType("text/plain");
                xhttp.send();

            }

            function fileOutput (url) {
                var xhttp = new XMLHttpRequest ();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 405) {
                        alert ("HTTP Error 405. Failed outputting '" + url + "'.");
                        
                    } else if (this.readyState == 4 && this.status == 200 && this.responseText.substring(0, "Error".length) !== "Error") {
                        //baseUrl = getBaseUrl(url);
                        baseUrl = url.substring (0, url.lastIndexOf("/"));
                        fullUrl = url;
                        document.title = url.substring (url.lastIndexOf("/") + 1);
                        backToBrowse ();
                    }
                };
                
                var dir = encodeURIComponent (url.substring(0, url.lastIndexOf("/") + 1))
                var fname = encodeURIComponent (url.substring (url.lastIndexOf("/") + 1));
                var fcontents = encodeURIComponent (parser.stringify (nodeTree, 50));
                xhttp.open("POST", "save-file", true);
                xhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                xhttp.send("fdir=" + dir + "&fname=" + fname + "&fcontents=" + fcontents);
            }

            function populate () {
                if (!fullUrl)
                    var url = "./projects/instructions/instructions.sdt";
                    //var url = "./projects/formulas/formulas.sdt";
                
                else
                    var url = fullUrl;

                if (!nodeTree) {
                    //baseUrl = getBaseUrl(url);
                    baseUrl = "./projects/instructions"
                    fullUrl = url;
                    document.title = url.substring (url.lastIndexOf("/") + 1);
                    nodeTree = ["tree", ["node"], ["branches", ["tree", ["node"], ["branches"]], ["tree", ["node"], ["branches"]]]];
                    if (server === "Node.js")
                        fileInput (url);
                        
                    else
                        onlineInput (url);

                } else {
                    function getNode (pl, cn, nt) {
                        if (pl > 0)
                            return getNode (pl - 1, cn.children[cn.index], nt[2][cn.index + 1]);
                        
                        else
                            return nt;
                    }
                    
                    if (!currentNode) {
                        document.getElementById("source").contentWindow.postMessage({msg: "populate", nodeTree: nodeTree, baseUrl: baseUrl}, "*");
                        document.getElementById("target").contentWindow.postMessage({msg: "populate", nodeTree: nodeTree, baseUrl: baseUrl}, "*");
                        
                    } else if (populateFrom === "browse") {
                        var nt = getNode (currentNode.pathLength, currentNode.cursor.children[0], nodeTree);
                        
                        document.getElementById("source").contentWindow.postMessage({msg: "populate", nodeTree: nt, currentNode: currentNode, baseUrl: baseUrl}, "*");
                        document.getElementById("target").contentWindow.postMessage({msg: "populate", nodeTree: nt, baseUrl: baseUrl}, "*");
                    
                    } else if (populateFrom === "edit/print") {
                        var nt = nodeTree;
                        
                        document.getElementById("source").contentWindow.postMessage({msg: "populate", nodeTree: nt}, "*");
                        document.getElementById("target").contentWindow.postMessage({msg: "populate", nodeTree: nt, baseUrl: baseUrl}, "*");

                        document.getElementById("source").contentWindow.postMessage({msg: "setCurNode", cursor: currentNode.cursor, pathLength: currentNode.pathLength}, "*");
                        document.getElementById("target").contentWindow.postMessage({msg: "setCurNode", cursor: currentNode.cursor, pathLength: currentNode.pathLength}, "*");
    
                        document.getElementById("source").contentWindow.postMessage({msg: "sync", cursor: currentNode.cursor, pathLength: currentNode.pathLength}, "*");
                        document.getElementById("target").contentWindow.postMessage({msg: "sync", cursor: currentNode.cursor, pathLength: currentNode.pathLength}, "*");
                    }
                }
            }
            
            function detectServer (callback) {
                var xhttp = new XMLHttpRequest ();
                xhttp.onreadystatechange = function () {
                    if (this.readyState == 4 && this.status == 200) {
                        callback (this.responseText);
                    }
                };
                xhttp.open("GET", "checkServer", true);
                xhttp.overrideMimeType("text/plain");
                xhttp.send();

            }
            
            window.onbeforeunload = function (event) {
                if (editedNotAccepted || document.title.charAt(0) === "*") {
                    if (!confirm(`You have unsaved changes. Close anyway?`)) {
                        event.preventDefault();
                        event.returnValue = '';
                    }
                }
            };
            
            var currentNode;
            var srcloaded, tgtloaded;
            var nodeTree;
            var populateFrom;
            var slide;
            var baseUrl;
            var fullUrl;
            var unnamed;
            var server;
            var editedNotAccepted = false;
            
            document.getElementById("source").addEventListener ('load', () => {
                srcloaded = true;
                if (tgtloaded) {
                    sync ();
                    populate ();
                }
            }, false);
            
            document.getElementById("target").addEventListener ('load', () => {
                tgtloaded = true;
                if (srcloaded) {
                    sync ();
                    populate ();
                }
            }, false);
            
            window.addEventListener("load", function () {
                lnks = document.querySelectorAll("a");
                for (var i = 0; i < lnks.length; i++)
                    if (document.getElementById("btnlhlp") !== lnks[i])
                        lnks[i].style.display = "inline";
            });
            
            function hideAll () {
                //document.getElementById("source").style.visibility = "hidden";
                //document.getElementById("target").style.visibility = "hidden";

                document.getElementById("btnlhlp").style.visibility = "hidden";
                document.getElementById("btnrhlp").style.visibility = "hidden";
                document.getElementById("btnupload").style.visibility = "hidden";
                document.getElementById("btnlslide").style.visibility = "hidden";
                document.getElementById("btndownload").style.visibility = "hidden";
                document.getElementById("btnrslide").style.visibility = "hidden";
                document.getElementById("btnledpr").style.visibility = "hidden";
                document.getElementById("btnredpr").style.visibility = "hidden";
            };
            
            addEventListener('orientationchange', (event) => {
            });

            document.getElementById("source").contentWindow.location.replace("./src/source-browse.html");
            document.getElementById("source").addEventListener("load", function () {
                document.getElementById("source").style.backgroundColor = "gray";
            });
            
            document.getElementById("target").contentWindow.location.replace("./src/target-browse.html");
            document.getElementById("target").addEventListener("load", function () {
                document.getElementById("target").style.backgroundColor = "gray";
            });
            
            if (window.innerWidth < window.innerHeight) {
                slide = "right";
            } else {
                slide = "both";
            }

            detectServer ((responseText) => {server = responseText});
        </script>
    </body>
</html>
